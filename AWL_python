import serial
import time
import os
ser = serial.Serial('/dev/ttyUSB0', 9600)

ser.write(b"l")
time.sleep(0.5)
readData = ""   #sisältää kaiken luetun datan, troubleshoottaukseen...
rawData = ""   #stringi, missä sisääntullut bitti binäärina
incData = "" #stringi, missä sisääntullut data ascii
currentFile = "" # luettavissa oleva tiedosto
FileList = [] #lista kaikista tiedostojen nimistä ilman .txt päätteitä
#Files = [] #luettavissa oleva tiedosto
DataRQ = [] #mistä tiedostoista pitää pyytää dataa
FileData = "" #vastaanotettu data tiedostoista

i = 0
while True:
    ser.timeout = 2
    rawData = ser.read() #lukee yhden bitin
    if (rawData == b"\r"):
        rawData = ser.read()    #skippaa \r

    incData = rawData.decode("utf-8")
    if (i < 4):
        currentFile += incData   #ottaa ylös vain tiedoston nimen ilman päätettä
        i += 1
        
    if (incData == "d"):    #jos end char, niin pois whilesta
        i = 0
        break

    if (incData == "\n"):   #rivinvaihto = uusi tiedostonimi tulossa
        FileList.append(currentFile)
        currentFile = ""
        i = 0

    readData += incData
    #print(incData)

print(readData)
#time.sleep(1)
print(FileList)
time.sleep(1)
print("Number of files: ", len(FileList))
#TÄHÄN ASTI TOIMII HYVIN

#vertaa onko mikään tiedosto uusi

i = 0
while (i < len(FileList)):
    FilePath = "C:/home/pi/AWL_Data/"
    FilePath += FileList[i]
    FilePath += ".txt"
    print(FilePath)
    if (os.path.exists(FilePath) == False):
        DataRQ.append(FileList[i])

    i += 1
    
i = 0
print("Data ei ole tiedostoista: ", DataRQ)

while(i < len(DataRQ)):
    FileData = ""
    ser.write(b's')
    ser.write(b'DataRQ[i]')
    print("Waiting for arduino to send data from", DataRQ[i], ".txt")
    time.sleep(10)
    print("Reading data....")
    while True:
        
        rawData = ser.read()
        if (rawData == b"\r"):
            rawData = ser.read()
            
        incData = rawData.decode("utf-8")
        if (rawData == "d"):
            break

        FileData += incData

    print("Data from ", DataRQ[i], " :", FileData)
    i =+ 30
    

if (len(FileList) > 14):
    pass
    
