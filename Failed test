#include <Wire.h>
#include <SD.h>

File rdFile;
File opnNext;
char FileName[10];

String IncData;
char CharData[10];

void setup(){

  Serial.begin(9600);
  delay(3000);
  Serial.println("Starting...");
  Serial.print("Initializing SD card...");
  pinMode(10, OUTPUT);
  if (!SD.begin(10)){
    Serial.println("initialization failed!");
    Serial.println("Stopping program.");
    while(1);
  }
  Serial.println("done!");
  Serial.println("Waiting for input");

}

void loop(){

  //FileName= "";
  
  Serial.println("Start of loop");

  while (Serial.available() == 0){
  }
  delay(300);
  //Serial.println(Serial.available());
  int j = 0;
  for (int a = Serial.available(); a != 0; a--){ 
    CharData[j] = Serial.read();
    //Serial.print(j);
    //Serial.println(CharData[j]);
    j++;
    //Serial.println("for done");
  }
  /*
  Serial.println(Serial.available());
   Serial.println("Done!");
   Serial.println(Serial.available());
   */
  //int q = 0;  //keroo kuinka monta kertaa wlempi while mennyt l채pi
  switch (CharData[0]){
  case 'd': //listaa kaikki filet
    //Serial.println("IT WORKS!");
    rdFile = SD.open("/");
    while (true){
      opnNext = rdFile.openNextFile();
      if (! opnNext){
        Serial.println("All files listed!!!");
        opnNext.close();
        break;
      }
      if (!opnNext.isDirectory()){
        Serial.print(opnNext.name());
        Serial.print("\t");
        Serial.println(opnNext.size(), DEC);
        opnNext.close();
      }
    }
    break;

  case 's':  //l채hett채채 halutun filen datan
    getFileName();  
    if (SD.exists(FileName)){
      rdFile = SD.open(FileName);
      while (rdFile.peek() != -1){
        Serial.write(rdFile.read());
      }
      rdFile.close();
      Serial.println();
      }
    else{
      Serial.println("File does not exist!");
    }
    break;
  default:
    Serial.println("Failed");
    break;
    }

  }


void getFileName(){
  snprintf(FileName, sizeof(FileName), "%c%c%c%c.txt", CharData[1], CharData[2], CharData[3], CharData[4]);
  Serial.println(FileName);
}
